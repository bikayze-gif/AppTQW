DROP VIEW IF EXISTS vw_logis_semaforo;

CREATE ALGORITHM=UNDEFINED DEFINER=`ncornejo`@`%` SQL SECURITY DEFINER VIEW `vw_logis_semaforo` AS with `ultima_transferencia` as (select `tlsst`.`serie` AS `serie`,`tut3`.`Rut` AS `rut_destino` from ((`tb_logis_tecnico_serie_transfiere` `tlsst` left join `tb_user_tqw` `tut3` on((`tut3`.`ID` = `tlsst`.`id_destino`))) join (select `tb_logis_tecnico_serie_transfiere`.`serie` AS `serie`,max(`tb_logis_tecnico_serie_transfiere`.`Fecha`) AS `max_fecha` from `tb_logis_tecnico_serie_transfiere` where (`tb_logis_tecnico_serie_transfiere`.`flag_gest` <> 0) group by `tb_logis_tecnico_serie_transfiere`.`serie`) `max_dates` on(((`tlsst`.`serie` = `max_dates`.`serie`) and (`tlsst`.`Fecha` = `max_dates`.`max_fecha`)))) where (`tlsst`.`flag_gest` <> 0)), `tb_logis_union_seriado` as (select `a`.`Serial` AS `Serial`,`a`.`Item` AS `Item`,`a`.`Org` AS `Org`,`a`.`Revision` AS `Revision`,`a`.`State` AS `State`,`a`.`Job` AS `job`,`a`.`Subinventory` AS `Subinventory`,`a`.`Flujo` AS `Flujo`,`a`.`Unit Number` AS `Unit Number`,`b`.`id_movimiento` AS `ult_movimiento` from ((select `directa`.`Serial` AS `Serial`,`directa`.`Item` AS `Item`,`directa`.`Org` AS `Org`,`directa`.`Revision` AS `Revision`,`directa`.`State` AS `State`,`directa`.`Job` AS `Job`,(case when (`ut`.`rut_destino` is not null) then `ut`.`rut_destino` else `directa`.`Subinventory` end) AS `Subinventory`,'DIRECTA' AS `Flujo`,`directa`.`Unit Number` AS `Unit Number` from (`tb_ferret_directa1` `directa` left join `ultima_transferencia` `ut` on((`ut`.`serie` = `directa`.`Serial`))) where (`directa`.`State` <> 'Issued out of stores') union all select `reversa`.`Serial` AS `Serial`,`reversa`.`Item` AS `Item`,`reversa`.`Org` AS `Org`,`reversa`.`Revision` AS `Revision`,`reversa`.`State` AS `State`,`reversa`.`Job` AS `Job`,`reversa`.`Locator` AS `Subinventory`,'REVERSA' AS `Flujo`,`reversa`.`Unit Number` AS `Unit Number` from `tb_logist_bdreversa` `reversa`) `a` left join `tb_logis_movimientos` `b` on((`a`.`Unit Number` = `b`.`id`)))), `rut_prefijos` as (select `tb_user_tqw`.`ID` AS `id`,`tb_user_tqw`.`nombre_short` AS `nombre_short`,`tb_user_tqw`.`Rut` AS `rut`,left(`tb_user_tqw`.`Rut`,(char_length(`tb_user_tqw`.`Rut`) - 2)) AS `rut_prefijo` from `tb_user_tqw` where (`tb_user_tqw`.`nombre_short` <> '')), `directa_stats` as (select `tut`.`nombre_short` AS `nombre_short`,count((case when ((`rz`.`ult_movimiento` is null) or (`rz`.`ult_movimiento` in (0,8,9,11,18))) then 1 end)) AS `PendientesCountDirecta`,sum((case when ((`rz`.`ult_movimiento` not in (8,9,11,18,0)) and (`rz`.`ult_movimiento` is not null)) then 1 else 0 end)) AS `GestionadosDirecta`,round(((count((case when ((`rz`.`ult_movimiento` is null) or (`rz`.`ult_movimiento` in (0,8,9,11,18))) then 1 end)) * 100.0) / nullif(count(0),0)),2) AS `PorcentajeDirecta`,sum((case when (`rz`.`ult_movimiento` in (3,12,5,4,20,16,13,7,2)) then 0 else `rz`.`job` end)) AS `Job`,sum((case when ((`rz`.`job` = 1) and ((`rz`.`ult_movimiento` <> 3) or (`rz`.`ult_movimiento` is null))) then 1 else 0 end)) AS `SUM_JOB`,`rz`.`Org` AS `Org` from (`tb_logis_union_seriado` `rz` left join `rut_prefijos` `tut` on((left(`rz`.`Subinventory`,(char_length(`rz`.`Subinventory`) - 2)) = `tut`.`rut_prefijo`))) where (`rz`.`Flujo` = 'DIRECTA') group by `tut`.`nombre_short`,`rz`.`Org` having (`tut`.`nombre_short` is not null)), `reversa_stats` as (select `tut`.`nombre_short` AS `nombre_short`,count((case when ((`rz_reversa`.`ult_movimiento` is null) or (`rz_reversa`.`ult_movimiento` in (8,9,11,18,10,23))) then 1 end)) AS `PendientesCountReversa`,sum((case when (`rz_reversa`.`ult_movimiento` in (6,7,22)) then 1 else 0 end)) AS `transitoReversa`,sum((case when (`rz_reversa`.`ult_movimiento` = 12) then 1 else 0 end)) AS `GestionadosReversa`,round(((count((case when ((`rz_reversa`.`ult_movimiento` is null) or (`rz_reversa`.`ult_movimiento` in (0,8,9,11,18,10))) then 1 end)) * 100.0) / nullif(count(0),0)),2) AS `PorcentajeReversa` from (`tb_logis_union_seriado` `rz_reversa` left join `rut_prefijos` `tut` on((left(`rz_reversa`.`Subinventory`,(char_length(`rz_reversa`.`Subinventory`) - 2)) = `tut`.`rut_prefijo`))) where (`rz_reversa`.`Flujo` = 'REVERSA') group by `tut`.`nombre_short` having (`tut`.`nombre_short` is not null)) select `tut`.`nombre_short` AS `Nombre_Short`,coalesce(`directa`.`PendientesCountDirecta`,0) AS `PendientesCount`,coalesce(`directa`.`GestionadosDirecta`,0) AS `Gestionados`,coalesce(`directa`.`PorcentajeDirecta`,0) AS `PorcentajeDirecta`,coalesce(`reversa`.`PendientesCountReversa`,0) AS `PendientesCountReversa`,coalesce(`reversa`.`transitoReversa`,0) AS `transitoReversa`,coalesce(`reversa`.`GestionadosReversa`,0) AS `GestionadosReversa`,coalesce(`reversa`.`PorcentajeReversa`,0) AS `PorcentajeReversa`,coalesce(`directa`.`SUM_JOB`,0) AS `SUM_JOB`,`directa`.`Org` AS `Org` from ((`tb_user_tqw` `tut` left join `directa_stats` `directa` on((`tut`.`nombre_short` = `directa`.`nombre_short`))) left join `reversa_stats` `reversa` on((`tut`.`nombre_short` = `reversa`.`nombre_short`))) where (((`directa`.`nombre_short` is not null) or (`reversa`.`nombre_short` is not null)) and (`tut`.`nombre_short` <> ''));
